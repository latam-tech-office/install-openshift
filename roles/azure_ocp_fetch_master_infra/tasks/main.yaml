- name: "MASTER: Fetching Information"
  azure_rm_virtualmachine: name={{ item.hostname }} location={{ region }}
                           resource_group={{ name }}
                           tags={{ labels }}
                           subscription_id={{ azure_subscription_id }} tenant={{ azure_tenant }}
                           client_id={{ azure_client_id }} secret={{ azure_secret }}
  with_items: "{{ master_definition }}"
  register: master_instances
  tags: [ ocp, azure, fetch, master ]

- name: "MASTER: (First MASTER only) Public IP: {{ master_instances.results[0].ansible_facts.azure_vm.properties.networkProfile.networkInterfaces[0].properties.ipConfigurations[0].properties.publicIPAddress.properties.ipAddress }}"
  set_fact: master_public_ip="{{ master_instances.results[0].ansible_facts.azure_vm.properties.networkProfile.networkInterfaces[0].properties.ipConfigurations[0].properties.publicIPAddress.properties.ipAddress }}"
  tags: [ ocp, azure, fetch, master ]

- name: "INFRA: Fetching Information"
  azure_rm_virtualmachine: name={{ item.hostname }} location={{ region }}
                           resource_group={{ name }}
                           tags={{ labels }}
                           subscription_id={{ azure_subscription_id }} tenant={{ azure_tenant }}
                           client_id={{ azure_client_id }} secret={{ azure_secret }}
  with_items: "{{ infra_definition }}"
  register: infra_instances
  tags: [ ocp, azure, fetch, infra ]

- name: "INFRA: (First INFRA only) Public IP: {{ infra_instances.results[0].ansible_facts.azure_vm.properties.networkProfile.networkInterfaces[0].properties.ipConfigurations[0].properties.publicIPAddress.properties.ipAddress }}"
  set_fact: infra_public_ip="{{ infra_instances.results[0].ansible_facts.azure_vm.properties.networkProfile.networkInterfaces[0].properties.ipConfigurations[0].properties.publicIPAddress.properties.ipAddress }}"
  tags: [ ocp, azure, fetch, infra ]

- name: "OPENSHIFT MASTER URL: Redefining (in case it wasn't defined)"
  set_fact: openshift_master_url="{{ master_public_ip }}.{{ dns_service_suffix }}"
  when: openshift_master_url is not defined or openshift_master_url is none
  tags: [ ocp, azure, fetch, master ]

- name: "CLOUD APPS URL: Redefining (in case it wasn't defined)"
  set_fact: openshift_cloudapps_url="{{ infra_public_ip }}.{{ dns_service_suffix }}"
  when: openshift_cloudapps_url is not defined or openshift_cloudapps_url is none
  tags: [ ocp, azure, fetch, infra ]
